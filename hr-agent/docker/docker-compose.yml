version: '3.8'

services:
  hr-agent:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: hr-agent
    ports:
      - "8002:8002"
    environment:
      - APP_ENV=production
      - DEBUG=false
      - API_KEY=${API_KEY}
      - ODOO_URL=${ODOO_URL}
      - ODOO_DB=${ODOO_DB}
      - ODOO_USER=${ODOO_USER}
      - ODOO_PASSWORD=${ODOO_PASSWORD}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - REDIS_URL=redis://redis:6379/1
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - HR_MANAGER_EMAILS=${HR_MANAGER_EMAILS}
      - TASK_MANAGEMENT_URL=${TASK_MANAGEMENT_URL:-http://task-management:8000}
      - TASK_MANAGEMENT_API_KEY=${TASK_MANAGEMENT_API_KEY}
    depends_on:
      - redis
    networks:
      - hr-agent-network
      - ailigent-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8002/api/v1/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  redis:
    image: redis:7-alpine
    container_name: hr-agent-redis
    ports:
      - "6380:6379"
    volumes:
      - redis-data:/data
    networks:
      - hr-agent-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

networks:
  hr-agent-network:
    driver: bridge
  ailigent-network:
    external: true
    name: ailigent-network

volumes:
  redis-data:
